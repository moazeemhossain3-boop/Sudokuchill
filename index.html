<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Sudoku Chill</title>
    <!-- Three.js for the 3D Hero Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --bg-color: #fff5f5;
            --grid-bg: #fff5f5;
            --text-main: #4a3737;
            --accent-color: #967272;
            --line-thick: #3d2b2b;
            --line-thin: #e2d1d1;
            --button-bg: #d6aaaa;
            --button-hover: #c29393;
            --card-shadow: rgba(74, 55, 55, 0.1);
            --highlight: rgba(150, 114, 114, 0.08);
            --selected: rgba(150, 114, 114, 0.2);
            --same-num-bg: rgba(150, 114, 114, 0.35);
            --error-color: #e53e3e;
            --success-glow: rgba(255, 215, 0, 0.3);
            --completion-flash: rgba(255, 255, 255, 0.6);
            --disabled-num: #d1d5db;
            --win-glow: rgba(214, 158, 158, 0.4);
        }

        [data-theme="night"] {
            --bg-color: #000000;
            --grid-bg: #000000;
            --text-main: #ffccaf;
            --accent-color: #d1a68d;
            --line-thick: #ffccaf;
            --line-thin: #33221a;
            --button-bg: #33221a;
            --button-hover: #4a3a30;
            --card-shadow: rgba(255, 204, 175, 0.05);
            --highlight: rgba(255, 204, 175, 0.05);
            --selected: rgba(255, 204, 175, 0.15);
            --same-num-bg: rgba(255, 204, 175, 0.3);
            --error-color: #ff6b6b;
            --success-glow: rgba(255, 236, 153, 0.3);
            --completion-flash: rgba(255, 204, 175, 0.4);
            --disabled-num: #1a1512;
            --win-glow: rgba(255, 204, 175, 0.2);
        }

        [data-theme="lavender"] {
            --bg-color: #f3f0ff;
            --grid-bg: #f3f0ff;
            --text-main: #4c406b;
            --accent-color: #8476aa;
            --line-thick: #4c406b;
            --line-thin: #d6d0ed;
            --button-bg: #b9b1d6;
            --button-hover: #a097c2;
            --card-shadow: rgba(76, 64, 107, 0.1);
            --highlight: rgba(132, 118, 170, 0.1);
            --selected: rgba(132, 118, 170, 0.25);
            --same-num-bg: rgba(132, 118, 170, 0.4);
            --error-color: #d53f8c;
            --success-glow: rgba(214, 188, 250, 0.5);
            --completion-flash: rgba(255, 255, 255, 0.5);
            --disabled-num: #cbd5e1;
            --win-glow: rgba(185, 177, 214, 0.4);
        }

        [data-theme="forest"] {
            --bg-color: #f0f4f0;
            --grid-bg: #f0f4f0;
            --text-main: #2d3a2d;
            --accent-color: #5b705b;
            --line-thick: #2d3a2d;
            --line-thin: #cedbce;
            --button-bg: #a8bba8;
            --button-hover: #8fa68f;
            --card-shadow: rgba(45, 58, 45, 0.1);
            --highlight: rgba(91, 112, 91, 0.1);
            --selected: rgba(91, 112, 91, 0.25);
            --same-num-bg: rgba(91, 112, 91, 0.4);
            --error-color: #c53030;
            --success-glow: rgba(198, 246, 213, 0.5);
            --completion-flash: rgba(255, 255, 255, 0.5);
            --disabled-num: #cbd5e1;
            --win-glow: rgba(168, 187, 168, 0.4);
        }

        [data-theme="ocean"] {
            --bg-color: #0f172a;
            --grid-bg: #0f172a;
            --text-main: #94a3b8;
            --accent-color: #38bdf8;
            --line-thick: #38bdf8;
            --line-thin: #1e293b;
            --button-bg: #1e293b;
            --button-hover: #334155;
            --card-shadow: rgba(0, 0, 0, 0.5);
            --highlight: rgba(56, 189, 248, 0.05);
            --selected: rgba(56, 189, 248, 0.15);
            --same-num-bg: rgba(56, 189, 248, 0.3);
            --error-color: #fb7185;
            --success-glow: rgba(56, 189, 248, 0.4);
            --completion-flash: rgba(255, 255, 255, 0.2);
            --disabled-num: #020617;
            --win-glow: rgba(56, 189, 248, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            transition: background-color 0.8s ease, color 0.8s ease;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* --- Views Management --- */
        .view {
            display: none;
            opacity: 0;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px 10px;
            box-sizing: border-box;
        }

        .view.active {
            display: flex;
            animation: viewFadeIn 0.8s ease-out forwards;
        }

        @keyframes viewFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #menu-view { justify-content: center; min-height: 100vh; }

        /* --- Hero 3D Container --- */
        #hero3DContainer {
            width: 300px;
            height: 300px;
            margin-bottom: 20px;
            cursor: grab;
            position: relative;
        }

        #hero3DContainer:active { cursor: grabbing; }

        .menu-options {
            width: 100%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-btn {
            background-color: var(--button-bg);
            color: var(--text-main);
            border: 1px solid var(--line-thin);
            padding: 18px;
            border-radius: 16px;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 300;
        }

        .menu-btn:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        .folder-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 10px;
            background: rgba(0,0,0,0.03);
            border-radius: 16px;
            margin-top: -10px;
            transition: max-height 0.6s ease-in-out, opacity 0.5s ease-in-out, padding 0.6s ease-in-out;
        }

        .folder-content.open {
            max-height: 500px; 
            opacity: 1;
            padding: 10px;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .diff-btn { padding: 12px; font-size: 0.9rem; letter-spacing: 1px; opacity: 0.9; }

        .settings-header {
            margin-top: 30px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.5;
            text-align: center;
        }

        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .current-theme-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--text-main);
            border: 2px solid var(--line-thick);
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .theme-menu {
            margin-top: 10px;
            background: var(--grid-bg);
            border: 1px solid var(--line-thin);
            padding: 10px;
            border-radius: 12px;
            display: none;
            gap: 10px;
            box-shadow: 0 10px 25px var(--card-shadow);
        }

        .theme-menu.active { display: flex; }

        .theme-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }

        h1.game-title {
            font-weight: 300;
            letter-spacing: 4px;
            margin: 10px 0 10px 0;
            color: var(--text-main);
            text-transform: uppercase;
            font-size: 1rem;
            text-align: center;
        }

        .game-stats-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 450px;
            padding: 0 10px 10px 10px;
            font-size: 0.75rem;
            opacity: 0.6;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #game-container {
            position: relative;
            background: var(--grid-bg);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 15px 30px var(--card-shadow);
        }

        canvas { display: block; cursor: pointer; border-radius: 2px; }

        .number-pad {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            max-width: 450px;
            width: 100%;
        }

        .num-btn {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--button-bg);
            color: var(--text-main);
            border: 1px solid var(--line-thin);
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        .num-btn.completed {
            background-color: var(--disabled-num);
            opacity: 0.3;
            pointer-events: none;
            border-color: transparent;
        }

        .num-btn:active { transform: scale(0.9); }

        .num-btn.clear { font-size: 0.9rem; font-weight: bold; }

        .controls { margin-top: 20px; display: flex; gap: 10px; }

        .ui-btn {
            background-color: transparent;
            color: var(--text-main);
            border: 1px solid var(--line-thin);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status {
            margin-top: 15px;
            font-size: 0.75rem;
            letter-spacing: 1px;
            opacity: 0.6;
            color: var(--accent-color);
            transition: opacity 1s ease;
            text-align: center;
            min-height: 1.2rem;
            padding: 0 20px;
        }

        .status.fade-out { opacity: 0; }

        /* Win Overlay */
        #win-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: transparent;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            opacity: 0;
            transition: opacity 3s ease;
        }

        #win-overlay.active { display: flex; opacity: 1; }

        .win-msg { 
            font-size: 1.8rem; 
            font-weight: 200; 
            letter-spacing: 8px; 
            margin-bottom: 20px; 
            text-transform: uppercase; 
            animation: driftUp 3s ease forwards;
        }

        .win-stats { 
            font-size: 0.9rem; 
            opacity: 0.7; 
            line-height: 2; 
            margin-bottom: 40px; 
            animation: driftUp 3.5s ease forwards;
        }

        @keyframes driftUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body data-theme="day">

    <div class="theme-selector">
        <div class="current-theme-dot" id="currentThemeDot"></div>
        <div class="theme-menu" id="themeMenu">
            <div class="theme-option" style="background: #fff5f5;" data-theme="day"></div>
            <div class="theme-option" style="background: #000000;" data-theme="night"></div>
            <div class="theme-option" style="background: #f3f0ff;" data-theme="lavender"></div>
            <div class="theme-option" style="background: #f0f4f0;" data-theme="forest"></div>
            <div class="theme-option" style="background: #0f172a;" data-theme="ocean"></div>
        </div>
    </div>

    <div id="win-overlay">
        <div class="win-msg">Tranquility Achieved</div>
        <div class="win-stats" id="winStatsText"></div>
        <button class="menu-btn" id="returnToPeaceBtn" style="width: 200px;">Return to Peace</button>
    </div>

    <div id="menu-view" class="view active">
        <div id="hero3DContainer"></div>
        <h1 style="font-weight: 200; letter-spacing: 8px; margin-bottom: 40px; text-transform: uppercase;">Sudoku Chill</h1>
        <div class="menu-options">
            <div class="menu-btn" id="dailyBtn">Daily Puzzle</div>
            <div class="menu-btn" id="freePlayTrigger">Free Play</div>
            <div class="folder-content" id="difficultyFolder">
                <div class="menu-btn diff-btn" data-diff="30">Casual</div>
                <div class="menu-btn diff-btn" data-diff="40">Easy</div>
                <div class="menu-btn diff-btn" data-diff="50">Medium</div>
                <div class="menu-btn diff-btn" data-diff="58">Hard</div>
                <div class="menu-btn diff-btn" data-diff="64">Extreme</div>
            </div>
            <div class="settings-header">Settings</div>
            <div class="menu-btn" id="themeMenuTrigger">Change Theme</div>
        </div>
    </div>

    <div id="game-view" class="view">
        <h1 class="game-title" id="gameModeTitle">Daily Sudoku</h1>
        <div class="game-stats-header">
            <span id="mistakeDisplay">Mistakes: 0</span>
            <span id="timerDisplay">Time: 00:00</span>
        </div>
        <div id="game-container">
            <canvas id="sudokuCanvas"></canvas>
        </div>
        <div class="number-pad" id="numberPad">
            <div class="num-btn" data-val="1">1</div>
            <div class="num-btn" data-val="2">2</div>
            <div class="num-btn" data-val="3">3</div>
            <div class="num-btn" data-val="4">4</div>
            <div class="num-btn" data-val="5">5</div>
            <div class="num-btn" data-val="6">6</div>
            <div class="num-btn" data-val="7">7</div>
            <div class="num-btn" data-val="8">8</div>
            <div class="num-btn" data-val="9">9</div>
            <div class="num-btn clear" data-val="0">X</div>
        </div>
        <div class="controls">
            <button class="ui-btn" id="backBtn">Menu</button>
            <button class="ui-btn" id="resetBtn">Reset</button>
        </div>
        <div class="status" id="statusText">Breathe in.</div>
    </div>

    <script>
        const canvas = document.getElementById('sudokuCanvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('statusText');
        const currentThemeDot = document.getElementById('currentThemeDot');
        const themeMenu = document.getElementById('themeMenu');
        const hero3DContainer = document.getElementById('hero3DContainer');
        const winOverlay = document.getElementById('win-overlay');
        const winStatsText = document.getElementById('winStatsText');
        const returnToPeaceBtn = document.getElementById('returnToPeaceBtn');
        
        const menuView = document.getElementById('menu-view');
        const gameView = document.getElementById('game-view');
        const folder = document.getElementById('difficultyFolder');
        
        let DISPLAY_SIZE = Math.min(window.innerWidth - 40, 450);
        canvas.width = DISPLAY_SIZE;
        canvas.height = DISPLAY_SIZE;
        let CELL_SIZE = DISPLAY_SIZE / 9;

        let solution = [];
        let puzzle = [];
        let isGiven = []; 
        let selectedCell = { r: -1, c: -1 };
        let isGameOver = false;
        
        // Stats
        let mistakes = 0;
        let startTime = null;
        let timerInterval = null;

        const quotes = [
            "Breathe in. Breathe out.", "Focus on the present moment.", "There is no rush.",
            "The journey is the destination.", "Quiet the mind, find your center.", "Let go of the mistakes of the past.",
            "One cell at a time.", "Peace begins with a single thought.", "Be patient with yourself.",
            "This moment is exactly as it should be.", "Relax your shoulders. Take a breath."
        ];
        let quoteInterval;

        // Visuals
        let feedback = Array(9).fill().map(() => Array(9).fill(null));
        let sparkles = [];
        let completedFlashes = []; 
        let winSequenceProgress = 0; 

        // --- Sudoku Logic ---

        function isValid(grid, row, col, num) {
            for (let i = 0; i < 9; i++) if (grid[row][i] === num || grid[i][col] === num) return false;
            const startRow = Math.floor(row / 3) * 3, startCol = Math.floor(col / 3) * 3;
            for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[startRow + i][startCol + j] === num) return false;
            return true;
        }

        function fillSudoku(grid, randomFunc = Math.random) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (grid[row][col] === 0) {
                        const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => randomFunc() - 0.5);
                        for (let num of nums) {
                            if (isValid(grid, row, col, num)) {
                                grid[row][col] = num;
                                if (fillSudoku(grid, randomFunc)) return true;
                                grid[row][col] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function seededRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // --- View Transitions ---

        function showView(viewId) {
            const activeView = document.querySelector('.view.active');
            if (activeView) activeView.classList.remove('active');
            
            setTimeout(() => {
                const newView = document.getElementById(viewId);
                newView.classList.add('active');
                if (viewId === 'game-view') render();
            }, 10);
        }

        function generatePuzzle(difficulty = 40, isDaily = false) {
            isGameOver = false; mistakes = 0; startTime = Date.now();
            winSequenceProgress = 0;
            document.getElementById('mistakeDisplay').innerText = `Mistakes: 0`;
            startTimer();

            let randFunc = Math.random;
            if (isDaily) {
                const d = new Date();
                let seed = d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
                randFunc = () => seededRandom(seed++);
                document.getElementById('gameModeTitle').innerText = "Daily Puzzle";
            } else {
                document.getElementById('gameModeTitle').innerText = "Free Play";
            }

            let grid = Array(9).fill().map(() => Array(9).fill(0));
            fillSudoku(grid, randFunc);
            solution = grid.map(row => [...row]);
            puzzle = grid.map(row => [...row]);
            isGiven = Array(9).fill().map(() => Array(9).fill(false));
            feedback = Array(9).fill().map(() => Array(9).fill(null));
            sparkles = []; completedFlashes = [];

            let attempts = difficulty;
            while (attempts > 0) {
                let r = Math.floor(randFunc() * 9), c = Math.floor(randFunc() * 9);
                if (puzzle[r][c] !== 0) { puzzle[r][c] = 0; attempts--; }
            }
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(puzzle[r][c] !== 0) isGiven[r][c] = true;
            
            selectedCell = { r: -1, c: -1 };
            startQuoteRotation();
            updateNumberPad();
            showView('game-view');
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(isGameOver) return;
                const sec = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `Time: ${m}:${s}`;
            }, 1000);
        }

        function startQuoteRotation() {
            if (quoteInterval) clearInterval(quoteInterval);
            statusText.innerText = quotes[Math.floor(Math.random() * quotes.length)];
            quoteInterval = setInterval(() => {
                if (isGameOver) return;
                statusText.classList.add('fade-out');
                setTimeout(() => {
                    statusText.innerText = quotes[Math.floor(Math.random() * quotes.length)];
                    statusText.classList.remove('fade-out');
                }, 1000);
            }, 12000);
        }

        // --- Hero 3D Animation Logic ---

        let scene, camera, renderer, cubeGroup;
        let targetRotationX = 0, targetRotationY = 0;
        let mouseX = 0, mouseY = 0;

        function initHero3D() {
            const width = 300, height = 300;
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
            camera.position.z = 10;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            hero3DContainer.appendChild(renderer.domElement);

            cubeGroup = new THREE.Group();
            scene.add(cubeGroup);

            // Create a 4x4x4 cube
            const spacing = 1.1;
            const offset = (3 * spacing) / 2;

            for (let x = 0; x < 4; x++) {
                for (let y = 0; y < 4; y++) {
                    for (let z = 0; z < 4; z++) {
                        // Only draw the outer shell for better aesthetics and performance
                        if (x === 0 || x === 3 || y === 0 || y === 3 || z === 0 || z === 3) {
                            const val = Math.random() > 0.7 ? Math.floor(Math.random() * 4) + 1 : null;
                            const mesh = createCellMesh(val);
                            mesh.position.set(x * spacing - offset, y * spacing - offset, z * spacing - offset);
                            cubeGroup.add(mesh);
                        }
                    }
                }
            }

            // Listen for mouse movements to influence rotation
            window.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth) * 2 - 1;
                mouseY = (e.clientY / window.innerHeight) * 2 - 1;
            });

            animate3D();
        }

        function createCellMesh(value) {
            const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            const colors = getThemeColors();
            
            const material = new THREE.MeshBasicMaterial({
                color: colors.text,
                transparent: true,
                opacity: 0.1,
                wireframe: false
            });

            const mesh = new THREE.Mesh(geometry, material);

            // Add edge lines
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMat = new THREE.LineBasicMaterial({ color: colors.lineThick, transparent: true, opacity: 0.3 });
            const line = new THREE.LineSegments(edges, lineMat);
            mesh.add(line);

            // If it has a value, draw it on faces
            if (value) {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = colors.text;
                ctx.font = 'Bold 40px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(value, 32, 32);

                const texture = new THREE.CanvasTexture(canvas);
                const textMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 0.8 });
                const textGeo = new THREE.BoxGeometry(0.81, 0.81, 0.81);
                const textMesh = new THREE.Mesh(textGeo, textMat);
                mesh.add(textMesh);
            }

            return mesh;
        }

        function animate3D() {
            requestAnimationFrame(animate3D);

            // Natural auto-rotation
            cubeGroup.rotation.y += 0.003;
            cubeGroup.rotation.x += 0.002;

            // Influence from mouse
            cubeGroup.rotation.y += mouseX * 0.01;
            cubeGroup.rotation.x += mouseY * 0.01;

            renderer.render(scene, camera);
        }

        function update3DTheme() {
            if (!cubeGroup) return;
            const colors = getThemeColors();
            cubeGroup.children.forEach(cell => {
                cell.material.color.set(colors.text);
                cell.children.forEach(child => {
                    if (child instanceof THREE.LineSegments) {
                        child.material.color.set(colors.lineThick);
                    }
                    if (child.material && child.material.map) {
                        // Re-draw text texture with new color
                        const canvas = child.material.map.image;
                        const ctx = canvas.getContext('2d');
                        const oldVal = cell.userData.val || (Math.floor(Math.random() * 4) + 1);
                        ctx.clearRect(0,0,64,64);
                        ctx.fillStyle = colors.text;
                        ctx.fillText(oldVal, 32, 32);
                        child.material.map.needsUpdate = true;
                    }
                });
            });
        }

        // --- Rendering Engine (Game) ---

        function render() {
            if (!gameView.classList.contains('active')) { requestAnimationFrame(render); return; }
            const colors = getThemeColors();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = colors.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);

            const now = Date.now();
            const focusedNum = (selectedCell.r !== -1 && !isGameOver) ? puzzle[selectedCell.r][selectedCell.c] : 0;

            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    completedFlashes = completedFlashes.filter(f => now - f.time < 1000);
                    completedFlashes.forEach(f => {
                        const age = (now - f.time) / 1000;
                        ctx.fillStyle = colors.completionGlow || colors.glow;
                        ctx.globalAlpha = (1 - age) * 0.5;
                        if(f.type === 'row' && f.index === r) ctx.fillRect(0, r * CELL_SIZE, canvas.width, CELL_SIZE);
                        if(f.type === 'col' && f.index === c) ctx.fillRect(c * CELL_SIZE, 0, CELL_SIZE, canvas.height);
                        if(f.type === 'box') {
                            const br = Math.floor(f.index / 3) * 3, bc = (f.index % 3) * 3;
                            if(r >= br && r < br+3 && c >= bc && c < bc+3) ctx.fillRect(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        }
                    });
                    ctx.globalAlpha = 1.0;

                    if(focusedNum !== 0 && puzzle[r][c] === focusedNum) {
                        ctx.fillStyle = colors.sameNumBg;
                        ctx.fillRect(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }

                    const f = feedback[r][c];
                    if (f && f.type === 'correct' && f.time > now - 800) {
                        const age = (now - f.time) / 800;
                        ctx.fillStyle = colors.glow; ctx.globalAlpha = 1 - age;
                        ctx.fillRect(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        ctx.globalAlpha = 1.0;
                    }
                }
            }

            if (selectedCell.r !== -1 && !isGameOver) {
                ctx.fillStyle = colors.highlight;
                ctx.fillRect(0, selectedCell.r * CELL_SIZE, canvas.width, CELL_SIZE);
                ctx.fillRect(selectedCell.c * CELL_SIZE, 0, CELL_SIZE, canvas.height);
                ctx.fillStyle = colors.selected;
                ctx.fillRect(selectedCell.c * CELL_SIZE, selectedCell.r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            }

            if (isGameOver) {
                winSequenceProgress = Math.min(1, winSequenceProgress + 0.005);
                const pulse = Math.sin(now / 1000) * 0.2 + 0.8; 
                ctx.fillStyle = colors.winGlow;
                ctx.globalAlpha = winSequenceProgress * pulse;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0;
            }

            for (let i = 0; i <= 9; i++) {
                ctx.beginPath();
                ctx.lineWidth = (i % 3 === 0) ? 2.5 : 0.8;
                ctx.strokeStyle = (i % 3 === 0) ? colors.thick : colors.thin;
                ctx.moveTo(i * CELL_SIZE, 0); ctx.lineTo(i * CELL_SIZE, canvas.height); ctx.stroke();
                ctx.moveTo(0, i * CELL_SIZE); ctx.lineTo(canvas.width, i * CELL_SIZE); ctx.stroke();
            }

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (puzzle[r][c] !== 0) {
                        const isIncorrect = feedback[r][c]?.type === 'incorrect';
                        ctx.fillStyle = isIncorrect ? colors.error : colors.text;
                        ctx.font = isGiven[r][c] 
                            ? `500 ${CELL_SIZE * 0.55}px 'Segoe UI', sans-serif`
                            : `300 ${CELL_SIZE * 0.55}px 'Segoe UI', sans-serif`;
                        
                        if (isGameOver) ctx.globalAlpha = 1 - (winSequenceProgress * 0.3);
                        ctx.fillText(puzzle[r][c], c * CELL_SIZE + CELL_SIZE / 2, r * CELL_SIZE + CELL_SIZE / 2);
                        ctx.globalAlpha = 1.0;
                    }
                }
            }

            sparkles = sparkles.filter(s => s.life > 0);
            for (let s of sparkles) {
                ctx.fillStyle = colors.text; ctx.globalAlpha = s.life;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
                s.x += s.vx; s.y += s.vy; s.life -= 0.02;
            }
            ctx.globalAlpha = 1.0;
            requestAnimationFrame(render);
        }

        function getThemeColors() {
            const style = getComputedStyle(document.body);
            return {
                text: style.getPropertyValue('--text-main').trim(),
                thick: style.getPropertyValue('--line-thick').trim(),
                thin: style.getPropertyValue('--line-thin').trim(),
                bg: style.getPropertyValue('--grid-bg').trim(),
                highlight: style.getPropertyValue('--highlight').trim(),
                selected: style.getPropertyValue('--selected').trim(),
                sameNumBg: style.getPropertyValue('--same-num-bg').trim(),
                error: style.getPropertyValue('--error-color').trim(),
                glow: style.getPropertyValue('--success-glow').trim(),
                winGlow: style.getPropertyValue('--win-glow').trim(),
                completionGlow: style.getPropertyValue('--completion-flash').trim(),
                lineThick: style.getPropertyValue('--line-thick').trim()
            };
        }

        function updateNumberPad() {
            const counts = Array(10).fill(0);
            for(let r=0; r<9; r++) {
                for(let c=0; c<9; c++) {
                    if(puzzle[r][c] === solution[r][c]) counts[puzzle[r][c]]++;
                }
            }
            document.querySelectorAll('.num-btn[data-val]').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                if(val === 0) return;
                if(counts[val] === 9) btn.classList.add('completed');
                else btn.classList.remove('completed');
            });
        }

        function triggerSparkles(r, c) {
            const centerX = c * CELL_SIZE + CELL_SIZE / 2, centerY = r * CELL_SIZE + CELL_SIZE / 2;
            for (let i = 0; i < 12; i++) {
                sparkles.push({
                    x: centerX, y: centerY, vx: (Math.random() - 0.5) * 3, vy: (Math.random() - 0.5) * 3,
                    life: 1.0, size: Math.random() * 3 + 1
                });
            }
        }

        function checkCompletions(r, c) {
            if(puzzle[r].every((val, idx) => val === solution[r][idx])) completedFlashes.push({type:'row', index:r, time:Date.now()});
            let colComplete = true;
            for(let i=0; i<9; i++) if(puzzle[i][c] !== solution[i][c]) colComplete = false;
            if(colComplete) completedFlashes.push({type:'col', index:c, time:Date.now()});
            const br = Math.floor(r/3)*3, bc = Math.floor(c/3)*3;
            let boxComplete = true;
            for(let i=br; i<br+3; i++) for(let j=bc; j<bc+3; j++) if(puzzle[i][j] !== solution[i][j]) boxComplete = false;
            if(boxComplete) completedFlashes.push({type:'box', index:(Math.floor(r/3)*3 + Math.floor(c/3)), time:Date.now()});
        }

        // --- Persistence Logic ---
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('sudoku-chill-theme', theme);
            update3DTheme();
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('sudoku-chill-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            }
        }

        // --- Event Listeners ---

        document.getElementById('dailyBtn').addEventListener('click', () => generatePuzzle(45, true));
        document.getElementById('freePlayTrigger').addEventListener('click', () => folder.classList.toggle('open'));
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.addEventListener('click', () => generatePuzzle(parseInt(btn.getAttribute('data-diff')), false));
        });
        document.getElementById('themeMenuTrigger').addEventListener('click', (e) => { e.stopPropagation(); themeMenu.classList.toggle('active'); });
        document.getElementById('backBtn').addEventListener('click', () => showView('menu-view'));
        document.getElementById('resetBtn').addEventListener('click', () => {
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(!isGiven[r][c]) { puzzle[r][c] = 0; feedback[r][c] = null; }
            updateNumberPad();
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            const c = Math.floor(x / CELL_SIZE), r = Math.floor(y / CELL_SIZE);
            if (r >= 0 && r < 9 && c >= 0 && c < 9) selectedCell = { r, c };
        });

        document.querySelectorAll('.num-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (selectedCell.r === -1 || isGameOver) return;
                const { r, c } = selectedCell;
                if (isGiven[r][c]) return;
                const val = parseInt(btn.getAttribute('data-val'));
                if (val === 0) { puzzle[r][c] = 0; feedback[r][c] = null; }
                else {
                    if (val !== solution[r][c] && puzzle[r][c] !== val) {
                        mistakes++;
                        document.getElementById('mistakeDisplay').innerText = `Mistakes: ${mistakes}`;
                    }
                    puzzle[r][c] = val;
                    if (val === solution[r][c]) {
                        feedback[r][c] = { type: 'correct', time: Date.now() };
                        triggerSparkles(r, c);
                        checkCompletions(r, c);
                    } else {
                        feedback[r][c] = { type: 'incorrect', time: Date.now() };
                    }
                }
                updateNumberPad();
                checkWin();
            });
        });

        function checkWin() {
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if (puzzle[r][c] !== solution[r][c]) return;
            isGameOver = true;
            const finalSec = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(finalSec / 60), s = finalSec % 60;
            winStatsText.innerText = `Time: ${m}m ${s}s â€¢ Mistakes: ${mistakes}`;
            setTimeout(() => {
                winOverlay.classList.add('active');
            }, 1500);
        }

        returnToPeaceBtn.addEventListener('click', () => {
            winOverlay.classList.remove('active');
            showView('menu-view');
            isGameOver = false;
            winSequenceProgress = 0;
            puzzle = [];
            solution = [];
        });

        currentThemeDot.addEventListener('click', (e) => { e.stopPropagation(); themeMenu.classList.toggle('active'); });
        document.querySelectorAll('.theme-option').forEach(opt => {
            opt.addEventListener('click', () => { 
                applyTheme(opt.getAttribute('data-theme'));
                themeMenu.classList.remove('active'); 
            });
        });
        window.addEventListener('click', () => themeMenu.classList.remove('active'));

        window.onload = () => { 
            loadSavedTheme(); 
            initHero3D();
            render(); 
        };

        window.addEventListener('resize', () => {
            DISPLAY_SIZE = Math.min(window.innerWidth - 40, 450);
            canvas.width = DISPLAY_SIZE; canvas.height = DISPLAY_SIZE; CELL_SIZE = DISPLAY_SIZE / 9;
        });
    </script>
</body>
</html>
